# 1. Тема и целевая аудитория

### Тема
ZOOM — это облачная платформа для проведения видео-конференций, вебинаров и других подобных онлайн мероприятий.

### Функционал MVP

- Авторизация
- Функционал видео-конференции:
   - Создание
   - Возможность приглашать участников
   - Отключение микрофона или камеры
   - Завершение

### Целевая аудитория
По официальным данным на 21 апреля 2020 года количество участников ежедневной встречи составляло около 300 млн пользователей. Сейчас это число составляет около 200 млн пользователей в день.

Пользователи приложения Zoom, как правило, относительно молоды. Основной целевой аудиторией являются люди в возрасте от 18 до 50 лет. 

Возрастная разбивка пользовательской базы приложения Zoom на iOS:

Возрастная группа | Доля пользователей
------------ | -------------
18-24 | 27%
25-34 | 23% <
35-49 | 22% <
50-64 | 19% <
65+ | 10% <

### Географическое распределение

Часть света | Доля пользователей
------------ | -------------
Австралия | 5.11%
Азия | 18.14%
Америка| 45.19%
Африка | 2.12%
Европа | 29.44%

# 2. Расчёт нагрузки

### Продуктовые метрики

- **Ежедневная аудитория** - 200 млн. чел
- **Средний размер хранилища на пользователя**:
    - Данные профиля 1 Мб: аватар и пользовательские данные
    - Записи видеозвонков в облачном хранилище(около 10% пользователей): Предположим, что в среднем пользователь сохраняет 2 часа видео записей в месяц в облачном хранилище. Возьмём разрешение записи в среднем 720p. Тогда объём записи будет составлять около 1 Гб в час. Следовательно, получаем, что пользователь за месяц занимает 2 Гб хранилища. В год на 1 пользователя уходит 24 Гб памяти. 
- **Среднее количество действий пользователя по типам за период**

Вид действия | Количество/Период
------------ | -------------
Создание конференции | 5 в месяц
Видео-разговор | 10 часов в месяц
Приглашение пользователя на конференцию | 10 в месяц
Смена аватарки | 1 в месяц
Смена имени пользователя | 1 в месяц
Отправка сообщения в чат | 30 в месяц
Сохранение записи локально | 2 в месяц
Сохранение записи в облаке | 1 в месяц

### Технические метрики

- **Размер хранения**
    - Профиль = 200.000.000 * 1Мб = 200.000 Гб
    - Записи видео-звонков = 24 Гб * 200.000.000 = 4,8млн Тб за год
    - Записи чатов = 83,3 Гб/час * 24 * 30 * 12 * 0,2(коэфф. сохранённых чатов) = 143.942 Гб за год
    - Хранилище сессий конференций = 38,5 Мб/сек * 1час(средняя продолжительность конференции) = 138,6 Гб
- **Сетевой трафик**
    - Видео-разговор = 1Гб/час * (10 * 200.000.000 / 30 / 24) = 2.777.777,8 Гб/час
    - Отправка сообщения в чат = 30 * 50byte * 200.000.000 / 30 / 24 = 0.39 Гб/час
    - Создание конференции = 385 * 100Кб = 38,5 Мб/сек
    - Приглашение пользователя на конференцию = 772 * 1Кб = 772 Кб/сек
    - Смена аватарки = 77 * 1Мб = 77Мб/сек
    - Сохранение записи в облаке = 154,3 Гб/сек  = 4,8млн Тб/год
- **Сетевой трафик при пике нагрузки**
    - Видео-разговор = 1Гб/час * (10 * 300.000.000 / 30 / 24) = 4.166.666,7 Гб/час
    - Отправка сообщения в чат = 30 * 50byte * 300.000.000 / 30 / 24 = 0.58 Гб/час
    - Создание конференции = 577 * 100Кб = 57,7 Мб/сек
    - Приглашение пользователя на конференцию = 1158 * 1Кб = 1156 Kб/сек
    - Смена аватарки = 115 * 1Мб = 155 Мб/сек
    - Сохранение записи в облаке = 2314 Гб/сек
- **RPS в разбивке по типам запросов**

Для подсчета RPS будем брать среднее кол-во определенного действия умножать его на кол-во пользователей и преобразуем это в измерение кол-во/сек.
Например для "Создание конференции" - 5/месяц * 200.000.000 / (30 * 24 * 60 * 60) ≈ 386 RPS.
Для видео-разговора будет брать пуллинг на каждую секунду, то есть, например, за 1 час будет произведено 60 * 60 = 3600 запросов.

Вид действия | RPS
------------ | -------------
Создание конференции | 386
Видео-разговор | 393.480
Приглашение пользователя на конференцию | 772
Смена аватарки | 77
Смена имени пользователя | 77
Отправка сообщения в чат | 2.314
Сохранение записи локально | 154
Сохранение записи в облаке | 77

# 3. Логическая схема

![Screenshot 2021-12-11 at 22 19 08](https://user-images.githubusercontent.com/57917516/145688918-6019fc16-b105-4419-9687-60f750d5412a.png)

# 4. Физическая схема

![Untitled drawio](https://user-images.githubusercontent.com/57917516/145689354-8200223a-cdb6-4674-ac26-2e6182ddbd12.png)

ИНДЕКСЫ:
- На таблицу user навесим индексы на nickname и image_url, потому что наиболее частые запросы для юзера - получить никнейм с аватаркой.
- Также стоит учесть, что на все primary key и foren key идет автоматическая индексация.

Также будет хранить сообщения в отсортированном виде по дате для того, чтобы быстро получать новые сообщения.

Таблицы conferense, user, messages, conference_members не будут иметь большую нагрузку, поэтому мы будем хранить их в PostgreSQL. Таблица sessions будет использоваться при входе пользователя в аккаунт, что происходит довольно часто, поэтому для нее будем использовать Tarantool, чтобы данные о сессиях быстро отдавались пользователям. 

Для всех БД будем использовать репликацию Master-Slave для увеличения надежности данных. Также для всех БД настроим шардирование по полю ID и будем располагать данные на разные сервера через каждые N полей. Для каждой БД число N будет разным из-за различного объема хранимых данных.

# 5. Технологии


Название | Область применения | Мотивация
------------ | ------------- | -------------
Ubuntu Server | OS | Стабильная, легко настраиваемая
Nginx | load balancer | Из коробки поддерживает методы балансировки. Удобный. Высокая скорость работы. Легко настроить.
Golang | Backend | Скорость работы, скорость компиляции, легкость разработки.
C++ | Desctop Client App | Высокая скорость работы, Кроссплатформенность (библиотека QT).
Postgres | DB(conferense, user, messages, conference_members) | Надежность, мощные и надёжные механизмы транзакций и репликации.
Tarantool | DB(sessions) | Скорость работы
Amazon S3 | Хранение файлов | Не нужно беспокоиться о хранении видео и изображений, Amazon все делаем сам

Бекенд стоит разделить на несколько сервисов для увеличения надежности, возможности масштабирования:
- Сервиса авторизации
- Сервис видеозвонков
   - микросервис загрузки видео/аудио
   - микросервис перекодировки видео
   - микросервис раздачи видео/аудио
- Сервис сообщений
- Сервис пользователей

# 6. Схема проекта

![Untitled drawio (2) drawio](https://user-images.githubusercontent.com/57917516/145716451-9b8f96fd-cc50-4c87-908f-2482356561b1.png)

Для балансировки используем L7 nginx.
Протокол общения между сервисами - gRPC.

# 7. Список серверов

Расположения ДЦ:
- Австралия (5.11% юзеров) - 1 ДЦ
- Азия (18.14% юзеров) - 2 ДЦ
- Америка (45.19% юзеров) - 5 ДЦ
- Африка (2.12% юзеров) - 1 ДЦ
- Европа (29.44% юзеров) - 3 ДЦ

Всего расположим 12 ДЦ, каждый из которых будет рассчитан на 10% пользователей.

### Nginx

По официальной документации Nginx его RPS на 8 ядер CPU и запросами не более 100КБ выдерживает 91,640 RPS. RPS видео-разговоров + аудио - около 2.500.000 RPS. Поэтому будет необходимо 28 серверов всего разделенных по ДЦ.
Параметр | Значение
------------ | -------------
CPU | 8
Network | 40Gbit/s
RAM | 16Gb
SSD | 512Gb

### Пользователи
##### Сервис
RPS на сервис сообщений будет составлять сумме RPS на смену аватарки и смене имени пользователя, а также авторизации. Это будет около 300-500 RPS, учитывая также запросы с других сервисов. Сетевой трафик - 155Мб/сек. Достаточно будет 2 сервера для работы с пользователями, но также можно взять по 1 менее мощному сервису на каждый ДЦ, чтобы задежка была небольшой.
Параметр | Значение
------------ | -------------
CPU | 4
Network | 5Gbit/s
RAM | 16Gb
SSD | 128Gb

##### PostgresSQL
200.000 Гб - размер хранения всех пользователей. Будем использовать 2 сервера со след. конфигурациями.

Параметр | Значение
------------ | -------------
CPU | 8
RAM | 16Gb
SSD | 30Tb
HDD | 80Tb

### Сообщения
##### Сервис
RPS на сервис пользователей будет составлять 2.314 RPS. Сетевой трафик - 0.58 Гб/час.
Для такого сетевого трафика подойдет 2 сервера.
Параметр | Значение
------------ | -------------
CPU | 8
Network | 5Gbit/s
RAM | 32Gb
SSD | 128Gb

##### PostgresSQL
143.942 Гб за год размер хранения всех сообщений. Каждый год будет добавлять 2 сервера со след конфигурациями:

Параметр | Значение
------------ | -------------
CPU | 8
RAM | 16Gb
SSD | 10Tb
HDD | 70Tb

### Конференции (видео-звонки)
##### Сервис
RPS на сервис будет составлять 6.558 * 60 RPS = 393.480 RPS, если отправка видео-контента будет происходить каждую секунду. И сетевой трафик около 0.77 Tb/сек. Для такого сетевого трафика и RPS подойдет 56 сервера.
Параметр | Значение
------------ | -------------
CPU | 8
Network | 60Gbit/s
RAM | 32Gb
SSD | 128Gb

##### PostgresSQL
Максимальными RPS для PostgreSql возьмем - 5000RPS. Тогда для 393.480 RPS будет необходимо 79 серверов с небольшим объемом данных, потому что мы храним только мету информацию видео-звонков.

Параметр | Значение
------------ | -------------
CPU | 4
RAM | 8Gb
HDD | 64Gb

### Сессия
##### Сервис:
Внешний RPS авторизации составляет 2.314. Для него потребуются максимум 2 сервера. Также к сервису авторизации обращаюся все остальные сервисы для проверки авторизации, тогда добавляется 9.257 RPS. Всего 11.571 RPS. Тогда на сервисе сессий нам понадобиться 2 сервера.
Параметр | Значение
------------ | -------------
CPU | 4
RAM | 8Gb
SSD | 64Gb


##### Tarantool:
Tarantool хранит свои данные в оперативной памяти, нам нужно еще подсчитать. Одна запись ключ-значение будет занимать примерно 40байт (int64 + sha_256). Тогда для 200.000.000 пользователей это займет 7.4 Гб. Значение не большое - хватит одного сервера.

Параметр | Значение
------------ | -------------
CPU | 8
Network | 40Gbit/s
RAM | 64Gb
SSD | 64Gb

# Используемые источники

- https://backlinko.com/zoom-users
- https://www.reviews.org/internet-service/how-much-data-does-zoom-use/
- http://firstround.com/review/the-three-infrastructure-mistakes-your-company-must-not-make/
- http://www.slideshare.net/tcng3716/ebay-architecture
- https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/
